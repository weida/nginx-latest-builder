name: Build and Push Docker Images

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  packages: write

jobs:
  docker:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant:
          - { dockerfile: 'Dockerfile', suffix: '', glibc: '2.39' }
          - { dockerfile: 'Dockerfile.compat', suffix: '-compat', glibc: '2.31' }
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Get nginx version
      id: version
      run: |
        NGINX_VERSION=$(curl -s "https://api.github.com/repos/nginx/nginx/releases" | grep -oP '"tag_name":\s*"\K[^"]+' | head -1 | sed 's/release-//')
        echo "nginx_version=$NGINX_VERSION" >> $GITHUB_OUTPUT
        echo "Nginx version: $NGINX_VERSION (glibc ${{ matrix.variant.glibc }})"
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.variant.dockerfile }}
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest${{ matrix.variant.suffix }}
          ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:${{ steps.version.outputs.nginx_version }}${{ matrix.variant.suffix }}
        cache-from: type=gha,scope=${{ matrix.variant.suffix }}
        cache-to: type=gha,mode=max,scope=${{ matrix.variant.suffix }}
    
    - name: Extract binaries from Docker image
      run: |
        # Extract amd64 binary
        docker pull --platform linux/amd64 ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest${{ matrix.variant.suffix }}
        CONTAINER_AMD64=$(docker create --platform linux/amd64 ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest${{ matrix.variant.suffix }})
        docker cp $CONTAINER_AMD64:/usr/local/nginx ./nginx-amd64
        
        rm -f nginx-amd64/logs/access.log nginx-amd64/logs/error.log
        touch nginx-amd64/logs/access.log nginx-amd64/logs/error.log
        
        cp -r install-scripts/* nginx-amd64/
        chmod +x nginx-amd64/*.sh
        
        tar czf nginx-${{ steps.version.outputs.nginx_version }}-linux-amd64${{ matrix.variant.suffix }}.tar.gz -C nginx-amd64 .
        docker rm $CONTAINER_AMD64
        rm -rf nginx-amd64
        
        # Extract arm64 binary
        docker pull --platform linux/arm64 ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest${{ matrix.variant.suffix }}
        CONTAINER_ARM64=$(docker create --platform linux/arm64 ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest${{ matrix.variant.suffix }})
        docker cp $CONTAINER_ARM64:/usr/local/nginx ./nginx-arm64
        
        rm -f nginx-arm64/logs/access.log nginx-arm64/logs/error.log
        touch nginx-arm64/logs/access.log nginx-arm64/logs/error.log
        
        cp -r install-scripts/* nginx-arm64/
        chmod +x nginx-arm64/*.sh
        
        tar czf nginx-${{ steps.version.outputs.nginx_version }}-linux-arm64${{ matrix.variant.suffix }}.tar.gz -C nginx-arm64 .
        docker rm $CONTAINER_ARM64
        rm -rf nginx-arm64
    
    - name: Create GitHub Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main' && matrix.variant.suffix == ''
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.nginx_version }}
        name: Nginx ${{ steps.version.outputs.nginx_version }}
        body: |
          ## Nginx ${{ steps.version.outputs.nginx_version }} with HTTP/3 Support
          
          ### Features
          - ✅ HTTP/2 support
          - ✅ HTTP/3 (QUIC) support
          - ✅ TLS 1.3
          - ✅ Latest OpenSSL, PCRE2, and zlib
          - ✅ Multi-architecture support (amd64, arm64)
          - ✅ Multiple glibc versions for compatibility
          
          ### Docker Images
          
          **Standard (glibc 2.39+)** - Ubuntu 24.04 base:
          ```bash
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:${{ steps.version.outputs.nginx_version }}
          ```
          
          **Compatible (glibc 2.31+)** - Debian 11 base, works on CentOS 7, Alibaba Cloud Linux 3:
          ```bash
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest-compat
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:${{ steps.version.outputs.nginx_version }}-compat
          ```
          
          ### Binary Installation
          
          **Choose the right version:**
          - Standard: For Ubuntu 22.04+, Debian 12+, RHEL 9+ (glibc 2.35+)
          - Compat: For CentOS 7, Alibaba Cloud Linux 3, Ubuntu 20.04, Debian 11 (glibc 2.31+)
          
          **AMD64 (x86_64)**:
          ```bash
          # Standard version
          tar xzf nginx-${{ steps.version.outputs.nginx_version }}-linux-amd64.tar.gz
          
          # Compatible version
          tar xzf nginx-${{ steps.version.outputs.nginx_version }}-linux-amd64-compat.tar.gz
          
          # Install
          sudo ./install.sh
          sudo systemctl start nginx
          ```
          
          **ARM64 (aarch64)**:
          ```bash
          # Standard version
          tar xzf nginx-${{ steps.version.outputs.nginx_version }}-linux-arm64.tar.gz
          
          # Compatible version
          tar xzf nginx-${{ steps.version.outputs.nginx_version }}-linux-arm64-compat.tar.gz
          
          # Install
          sudo ./install.sh
          sudo systemctl start nginx
          ```
          
          ### Build Information
          - Nginx: ${{ steps.version.outputs.nginx_version }}
          - Architectures: amd64, arm64
          - glibc versions: 2.39 (standard), 2.31 (compat)
          - Built: ${{ github.event.head_commit.timestamp }}
          - Commit: ${{ github.sha }}
        files: |
          nginx-${{ steps.version.outputs.nginx_version }}-linux-*.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update Docker Hub Description
      if: github.event_name == 'push' && github.ref == 'refs/heads/main' && matrix.variant.suffix == ''
      run: |
        sudo apt-get update && sudo apt-get install -y jq
        chmod +x update-dockerhub-description.sh
        DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }} ./update-dockerhub-description.sh
