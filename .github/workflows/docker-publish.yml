name: Build and Push Docker Images

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  packages: write

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Get nginx version
      id: version
      run: |
        # Get nginx version from GitHub API
        NGINX_VERSION=$(curl -s "https://api.github.com/repos/nginx/nginx/releases" | grep -oP '"tag_name":\s*"\K[^"]+' | head -1 | sed 's/release-//')
        echo "nginx_version=$NGINX_VERSION" >> $GITHUB_OUTPUT
        echo "Nginx version: $NGINX_VERSION"
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:${{ steps.version.outputs.nginx_version }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Extract binaries from Docker image
      run: |
        # Extract amd64 binary
        docker pull --platform linux/amd64 ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest
        CONTAINER_AMD64=$(docker create --platform linux/amd64 ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest)
        docker cp $CONTAINER_AMD64:/usr/local/nginx ./nginx-amd64
        tar czf nginx-${{ steps.version.outputs.nginx_version }}-linux-amd64.tar.gz -C nginx-amd64 .
        docker rm $CONTAINER_AMD64
        rm -rf nginx-amd64
        
        # Extract arm64 binary
        docker pull --platform linux/arm64 ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest
        CONTAINER_ARM64=$(docker create --platform linux/arm64 ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest)
        docker cp $CONTAINER_ARM64:/usr/local/nginx ./nginx-arm64
        tar czf nginx-${{ steps.version.outputs.nginx_version }}-linux-arm64.tar.gz -C nginx-arm64 .
        docker rm $CONTAINER_ARM64
        rm -rf nginx-arm64
    
    - name: Create GitHub Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.nginx_version }}
        name: Nginx ${{ steps.version.outputs.nginx_version }}
        body: |
          ## Nginx ${{ steps.version.outputs.nginx_version }} with HTTP/3 Support
          
          ### Features
          - ✅ HTTP/2 support
          - ✅ HTTP/3 (QUIC) support
          - ✅ TLS 1.3
          - ✅ Latest OpenSSL, PCRE2, and zlib
          - ✅ Multi-architecture support (amd64, arm64)
          
          ### Docker Images
          ```bash
          # Pull latest
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:latest
          
          # Pull specific version
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nginx-http3:${{ steps.version.outputs.nginx_version }}
          ```
          
          ### Binary Installation
          Download the tarball for your architecture, extract and run:
          
          **AMD64 (x86_64)**:
          ```bash
          tar xzf nginx-${{ steps.version.outputs.nginx_version }}-linux-amd64.tar.gz
          cd sbin
          ./nginx
          ```
          
          **ARM64 (aarch64)**:
          ```bash
          tar xzf nginx-${{ steps.version.outputs.nginx_version }}-linux-arm64.tar.gz
          cd sbin
          ./nginx
          ```
          
          ### Build Information
          - Nginx: ${{ steps.version.outputs.nginx_version }}
          - Architectures: amd64, arm64
          - Built: ${{ github.event.head_commit.timestamp }}
          - Commit: ${{ github.sha }}
        files: |
          nginx-${{ steps.version.outputs.nginx_version }}-linux-amd64.tar.gz
          nginx-${{ steps.version.outputs.nginx_version }}-linux-arm64.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update Docker Hub Description
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        sudo apt-get update && sudo apt-get install -y jq
        chmod +x update-dockerhub-description.sh
        DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }} ./update-dockerhub-description.sh
